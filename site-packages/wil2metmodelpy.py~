import sys
import string

def wil2metmodel (wilfname): 
	wilfile = open (wilfname, "r")
	modelname = wilfname[0:(len(wilfname)-4)]
	biomassfile = open(modelname + ".biomass", "w")
	reactionsfile = open(modelname + ".reactions", "w")
	sourcesfile = open(modelname + ".sources", "w")
	escapesfile = open(modelname + ".escapes", "w")
	
	lineiterator = iter (wilfile.readlines())
	getreactions = 0
	line = ''
	while 'Biomass Equation' not in line:
		line = lineiterator.next()
	line = lineiterator.next()
	if len(line) > 2:
		biomass = line.rstrip()
		if ':' in line:
			biomass = biomass.split(":")
			compartment = biomass[0].rstrip()
			reaction = biomass[1]
			reaction = reaction.split("-->")
			reactants = reaction[0].split(" + ")
			products = reaction[1].split(" + ")
			for reactant in reactants:
				reactant = reactant.split()
				if len(reactant) == 2:
					biomassfile.write("%s%s\t%s\treactant\n" % (reactant[1], compartment, reactant[0])) 
				else:
					biomassfile.write("%s%s\t1.0\treactant\n" % (reactant[0], compartment)) 
			biomassfile.write("\n")
			for product in products:
				if product != '':
					product = product.split()
					if len(product) == 2:	
						biomassfile.write("%s%s\t%s\tproduct\n" % (product[1], compartment, product[0]))
					else:
						biomassfile.write("%s%s\t1.0\tproduct\n" % (product[0], compartment))
		else:
			reaction = biomass.split("-->")
			reactants = reaction[0].split(" + ")
			products = reaction[1].split(" + ")
			for reactant in reactants:
				reactant = reactant.split()
				if len(reactant) == 2:
					biomassfile.write("%s\t%s\treactant\n" % (reactant[1], reactant[0])) 
				else:		
					biomassfile.write("%s\t1.0\treactant\n" % (reactant[0])) 
			biomassfile.write("\n")
			for product in products:
				if product != '':
					product = product.split()
					if len(product) == 2:
						biomassfile.write("%s\t%s\tproduct\n" % (product[1], product[0]))
					else:
						biomassfile.write("%s\t1.0\tproduct\n" % (product[0]))
			
	while 'Reactions' not in line:
		line = lineiterator.next()
	line = lineiterator.next()
	while 'Sources' not in line:
		if len(line) > 2:
			[pathway, ec, id, reversible, name, reaction, confidence, gpr, notes] = line.split('\t')
			reaction = reaction.lstrip()
			reaction = reaction.rstrip()
			if id[:2] != 'R_':
				id = 'R_' + id
			reactionsfile.write("%s\t%s\t%s\t%s\t%s\t%s\n" % (id, name, reversible, pathway, ec, reaction))
		line = lineiterator.next()
	line = lineiterator.next()
	while 'Escapes' not in line:
		if len(line) > 2:
			source = line.rstrip() 
			sourcesfile.write("%s\n" % (source))
		line = lineiterator.next()
	line = lineiterator.next()
	while 'Genes' not in line:
		if len(line) > 2:
			escape = line.rstrip() 
			escapesfile.write("%s\n" % (escape))
		line = lineiterator.next()
   
